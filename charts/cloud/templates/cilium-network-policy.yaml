{{- if .Values.ciliumNetworkPolicy.enabled }}
# Cilium Network Policies
# NGINX is fully open (routing layer)
# Backend services (API, Web, DB) are protected with mTLS
# Reference: https://docs.cilium.io/en/stable/security/policy/

---
# Policy 0: Base Egress Policy for All Pods
# Allows DNS, health checks, and external access
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: base-egress-policy
  namespace: {{ .Release.Namespace }}
spec:
  endpointSelector: {}
  egress:
    # Allow DNS queries to kube-dns
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: kube-system
            k8s-app: kube-dns
      toPorts:
        - ports:
            - port: "53"
              protocol: UDP
            - port: "53"
              protocol: TCP
    # Allow egress to host (kubelet health checks, node services)
    - toEntities:
        - host
    # Allow egress to other pods in the cluster
    - toEntities:
        - cluster
    # Allow egress to external (ECR, external APIs, etc.)
    - toEntities:
        - world

---
# Policy 1: Protect API Pod
# Allows access from NGINX, UT, and Analytics Web pods with mTLS
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: api-ingress-policy
  namespace: {{ .Release.Namespace }}
spec:
  endpointSelector:
    matchLabels:
      app: ent-cloud-api
  ingress:
    # Allow traffic from NGINX, UT, and Analytics Web pods (mTLS required)
    - fromEndpoints:
        - matchLabels:
            app: nginx
        {{- if and .Values.userTesting.enabled .Values.userTesting.useLegacy }}
        - matchLabels:
            app: ent-cloud-ut
        {{- end }}
        {{- if and .Values.userTesting.enabled (not .Values.userTesting.useLegacy) }}
        - matchLabels:
            app: user-testing-server
        {{- end }}
        {{- if .Values.analytics.enabled }}
        - matchLabels:
            app: ent-analytics-web
        {{- end }}
      authentication:
        mode: "required"
      toPorts:
        - ports:
            - port: "3333"
              protocol: TCP
    # Allow health checks from kubelet (host → pod)
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "3333"
              protocol: TCP

---
# Policy 2: Protect Web Pod
# Only allows access from NGINX pod with mTLS
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: web-ingress-policy
  namespace: {{ .Release.Namespace }}
spec:
  endpointSelector:
    matchLabels:
      app: ent-cloud-web
  ingress:
    # Allow traffic from NGINX pod only (mTLS required)
    - fromEndpoints:
        - matchLabels:
            app: nginx
      authentication:
        mode: "required"
      toPorts:
        - ports:
            - port: "3000"
              protocol: TCP
    # Allow health checks from kubelet (host → pod)
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "3000"
              protocol: TCP

---
# Policy 3: Protect Database Pod (Main Cloud DB)
# Allows access from API and Analytics API pods with mTLS (most critical!)
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: db-access-policy
  namespace: {{ .Release.Namespace }}
spec:
  endpointSelector:
    matchLabels:
      app: db
  ingress:
    # Allow API, User Testing, and Analytics API pods to access DB (mTLS required)
    - fromEndpoints:
        - matchLabels:
            app: ent-cloud-api
        {{- if and .Values.userTesting.enabled .Values.userTesting.useLegacy }}
        - matchLabels:
            app: ent-cloud-ut
        {{- end }}
        {{- if .Values.analytics.enabled }}
        - matchLabels:
            app: ent-analytics-api
        {{- end }}
      authentication:
        mode: "required"
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP
    # Allow health checks from kubelet (host → pod)
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP

{{- if and .Values.userTesting.enabled .Values.userTesting.useLegacy }}
---
# Policy 4a: Protect Legacy User Testing Pod (ent-cloud-ut)
# Only allows access from NGINX pod with mTLS
# Supports WebSocket connections on port 8081
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: user-testing-legacy-ingress-policy
  namespace: {{ .Release.Namespace }}
spec:
  endpointSelector:
    matchLabels:
      app: ent-cloud-ut
  ingress:
    # Allow HTTP and WebSocket traffic from NGINX pod only (mTLS required)
    - fromEndpoints:
        - matchLabels:
            app: nginx
      authentication:
        mode: "required"
      toPorts:
        # HTTP API (service port 80 → pod port 4444)
        - ports:
            - port: "4444"
              protocol: TCP
        # WebSocket (service port 8081 → pod port 4445)
        - ports:
            - port: "4445"
              protocol: TCP
    # Allow health checks from kubelet (host → pod)
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "4444"
              protocol: TCP
            - port: "4445"
              protocol: TCP
{{- end }}

{{- if and .Values.userTesting.enabled (not .Values.userTesting.useLegacy) }}
---
# Policy 4b: Protect User Testing Server (new NestJS version)
# Only allows access from NGINX pod with mTLS
# Port 3030 for REST API and WebSocket (Socket.IO)
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: user-testing-server-policy
  namespace: {{ .Release.Namespace }}
spec:
  endpointSelector:
    matchLabels:
      app: user-testing-server
  ingress:
    # Allow HTTP and WebSocket traffic from NGINX pod only (mTLS required)
    - fromEndpoints:
        - matchLabels:
            app: nginx
      authentication:
        mode: "required"
      toPorts:
        - ports:
            - port: "3030"
              protocol: TCP
    # Allow health checks from kubelet (host → pod)
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "3030"
              protocol: TCP

---
# Policy 4c: Protect User Testing Database
# Only allows access from user-testing-server with mTLS
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: user-testing-db-policy
  namespace: {{ .Release.Namespace }}
spec:
  endpointSelector:
    matchLabels:
      app: user-testing-db
  ingress:
    # Allow traffic from user-testing-server only (mTLS required)
    - fromEndpoints:
        - matchLabels:
            app: user-testing-server
      authentication:
        mode: "required"
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP
    # Allow health checks from kubelet (host → pod)
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP

---
# Policy 4d: Protect User Testing Redis
# Only allows access from user-testing-server with mTLS
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: user-testing-redis-policy
  namespace: {{ .Release.Namespace }}
spec:
  endpointSelector:
    matchLabels:
      app: user-testing-redis
  ingress:
    # Allow traffic from user-testing-server only (mTLS required)
    - fromEndpoints:
        - matchLabels:
            app: user-testing-server
      authentication:
        mode: "required"
      toPorts:
        - ports:
            - port: "6379"
              protocol: TCP
    # Allow health checks from kubelet (host → pod)
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "6379"
              protocol: TCP
{{- end }}

{{- if .Values.analytics.enabled }}
---
# Policy 5: Protect Analytics Web Pod
# Only allows access from NGINX pod with mTLS
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: analytics-web-ingress-policy
  namespace: {{ .Release.Namespace }}
spec:
  endpointSelector:
    matchLabels:
      app: ent-analytics-web
  ingress:
    # Allow traffic from NGINX pod only (mTLS required)
    - fromEndpoints:
        - matchLabels:
            app: nginx
      authentication:
        mode: "required"
      toPorts:
        - ports:
            - port: "8050"
              protocol: TCP
    # Allow health checks from kubelet (host → pod)
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "8050"
              protocol: TCP

---
# Policy 6: Protect Analytics API Pod
# Allows access from NGINX and Analytics Web pods with mTLS
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: analytics-api-ingress-policy
  namespace: {{ .Release.Namespace }}
spec:
  endpointSelector:
    matchLabels:
      app: ent-analytics-api
  ingress:
    # Allow traffic from NGINX and Analytics Web pods (mTLS required)
    - fromEndpoints:
        - matchLabels:
            app: nginx
        - matchLabels:
            app: ent-analytics-web
      authentication:
        mode: "required"
      toPorts:
        - ports:
            - port: "8000"
              protocol: TCP
    # Allow health checks from kubelet (host → pod)
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "8000"
              protocol: TCP
{{- end }}
{{- end }}
