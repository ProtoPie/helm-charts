{{- if .Values.ciliumNetworkPolicy.enabled }}
# Cilium Network Policies with SPIFFE mTLS
# NGINX is fully open (routing layer)
# Backend services are protected with mTLS via SPIFFE IDs
# Reference: https://docs.cilium.io/en/stable/security/policy/

---
# Policy 1: Protect API Pod
# Allows access from NGINX, UT, and Analytics Web pods with SPIFFE mTLS
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: api-ingress-policy
  namespace: {{ .Release.Namespace }}
spec:
  endpointSelector:
    matchLabels:
      app: ent-cloud-api
  ingress:
    # Allow traffic with SPIFFE mTLS
    - fromEndpoints:
        - matchLabels:
            app: nginx
        {{- if and .Values.userTesting.enabled .Values.userTesting.useLegacy }}
        - matchLabels:
            app: ent-cloud-ut
        {{- end }}
        {{- if and .Values.userTesting.enabled (not .Values.userTesting.useLegacy) }}
        - matchLabels:
            app: user-testing-server
        {{- end }}
        {{- if .Values.analytics.enabled }}
        - matchLabels:
            app: ent-analytics-web
        {{- end }}
      toPorts:
        - ports:
            - port: "3333"
              protocol: TCP
          terminatingTLS:
            spiffe:
              peerIDs:
                - spiffe://{{ .Values.ciliumNetworkPolicy.trustDomain }}/ns/{{ .Release.Namespace }}/sa/nginx
                {{- if and .Values.userTesting.enabled .Values.userTesting.useLegacy }}
                - spiffe://{{ .Values.ciliumNetworkPolicy.trustDomain }}/ns/{{ .Release.Namespace }}/sa/ent-cloud-ut
                {{- end }}
                {{- if and .Values.userTesting.enabled (not .Values.userTesting.useLegacy) }}
                - spiffe://{{ .Values.ciliumNetworkPolicy.trustDomain }}/ns/{{ .Release.Namespace }}/sa/user-testing-server
                {{- end }}
                {{- if .Values.analytics.enabled }}
                - spiffe://{{ .Values.ciliumNetworkPolicy.trustDomain }}/ns/{{ .Release.Namespace }}/sa/ent-analytics-web
                {{- end }}
    # Allow health checks from kubelet
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "3333"
              protocol: TCP

---
# Policy 2: Protect Web Pod
# Only allows access from NGINX pod with SPIFFE mTLS
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: web-ingress-policy
  namespace: {{ .Release.Namespace }}
spec:
  endpointSelector:
    matchLabels:
      app: ent-cloud-web
  ingress:
    # Allow traffic from NGINX pod with SPIFFE mTLS
    - fromEndpoints:
        - matchLabels:
            app: nginx
      toPorts:
        - ports:
            - port: "3000"
              protocol: TCP
          terminatingTLS:
            spiffe:
              peerIDs:
                - spiffe://{{ .Values.ciliumNetworkPolicy.trustDomain }}/ns/{{ .Release.Namespace }}/sa/nginx
    # Allow health checks from kubelet
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "3000"
              protocol: TCP

---
# Policy 3: Protect Database Pod (Main Cloud DB)
# Allows access from API and Analytics API pods with SPIFFE mTLS
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: db-access-policy
  namespace: {{ .Release.Namespace }}
spec:
  endpointSelector:
    matchLabels:
      app: db
  ingress:
    # Allow traffic with SPIFFE mTLS
    - fromEndpoints:
        - matchLabels:
            app: ent-cloud-api
        {{- if and .Values.userTesting.enabled .Values.userTesting.useLegacy }}
        - matchLabels:
            app: ent-cloud-ut
        {{- end }}
        {{- if .Values.analytics.enabled }}
        - matchLabels:
            app: ent-analytics-api
        {{- end }}
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP
          terminatingTLS:
            spiffe:
              peerIDs:
                - spiffe://{{ .Values.ciliumNetworkPolicy.trustDomain }}/ns/{{ .Release.Namespace }}/sa/ent-cloud-api
                {{- if and .Values.userTesting.enabled .Values.userTesting.useLegacy }}
                - spiffe://{{ .Values.ciliumNetworkPolicy.trustDomain }}/ns/{{ .Release.Namespace }}/sa/ent-cloud-ut
                {{- end }}
                {{- if .Values.analytics.enabled }}
                - spiffe://{{ .Values.ciliumNetworkPolicy.trustDomain }}/ns/{{ .Release.Namespace }}/sa/ent-analytics-api
                {{- end }}
    # Allow health checks from kubelet
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP

{{- if and .Values.userTesting.enabled .Values.userTesting.useLegacy }}
---
# Policy 4a: Protect Legacy User Testing Pod (ent-cloud-ut)
# Only allows access from NGINX pod with SPIFFE mTLS
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: user-testing-legacy-ingress-policy
  namespace: {{ .Release.Namespace }}
spec:
  endpointSelector:
    matchLabels:
      app: ent-cloud-ut
  ingress:
    # Allow traffic from NGINX pod with SPIFFE mTLS
    - fromEndpoints:
        - matchLabels:
            app: nginx
      toPorts:
        - ports:
            - port: "4444"
              protocol: TCP
            - port: "4445"
              protocol: TCP
          terminatingTLS:
            spiffe:
              peerIDs:
                - spiffe://{{ .Values.ciliumNetworkPolicy.trustDomain }}/ns/{{ .Release.Namespace }}/sa/nginx
    # Allow health checks from kubelet
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "4444"
              protocol: TCP
            - port: "4445"
              protocol: TCP
{{- end }}

{{- if and .Values.userTesting.enabled (not .Values.userTesting.useLegacy) }}
---
# Policy 4b: Protect User Testing Server (new NestJS version)
# Only allows access from NGINX pod with SPIFFE mTLS
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: user-testing-server-policy
  namespace: {{ .Release.Namespace }}
spec:
  endpointSelector:
    matchLabels:
      app: user-testing-server
  ingress:
    # Allow traffic from NGINX pod with SPIFFE mTLS
    - fromEndpoints:
        - matchLabels:
            app: nginx
      toPorts:
        - ports:
            - port: "3030"
              protocol: TCP
          terminatingTLS:
            spiffe:
              peerIDs:
                - spiffe://{{ .Values.ciliumNetworkPolicy.trustDomain }}/ns/{{ .Release.Namespace }}/sa/nginx
    # Allow health checks from kubelet
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "3030"
              protocol: TCP

---
# Policy 4c: Protect User Testing Database
# Only allows access from user-testing-server with SPIFFE mTLS
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: user-testing-db-policy
  namespace: {{ .Release.Namespace }}
spec:
  endpointSelector:
    matchLabels:
      app: user-testing-db
  ingress:
    # Allow traffic from user-testing-server with SPIFFE mTLS
    - fromEndpoints:
        - matchLabels:
            app: user-testing-server
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP
          terminatingTLS:
            spiffe:
              peerIDs:
                - spiffe://{{ .Values.ciliumNetworkPolicy.trustDomain }}/ns/{{ .Release.Namespace }}/sa/user-testing-server
    # Allow health checks from kubelet
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP

---
# Policy 4d: Protect User Testing Redis
# Only allows access from user-testing-server with SPIFFE mTLS
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: user-testing-redis-policy
  namespace: {{ .Release.Namespace }}
spec:
  endpointSelector:
    matchLabels:
      app: user-testing-redis
  ingress:
    # Allow traffic from user-testing-server with SPIFFE mTLS
    - fromEndpoints:
        - matchLabels:
            app: user-testing-server
      toPorts:
        - ports:
            - port: "6379"
              protocol: TCP
          terminatingTLS:
            spiffe:
              peerIDs:
                - spiffe://{{ .Values.ciliumNetworkPolicy.trustDomain }}/ns/{{ .Release.Namespace }}/sa/user-testing-server
    # Allow health checks from kubelet
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "6379"
              protocol: TCP
{{- end }}

{{- if .Values.analytics.enabled }}
---
# Policy 5: Protect Analytics Web Pod
# Only allows access from NGINX pod with SPIFFE mTLS
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: analytics-web-ingress-policy
  namespace: {{ .Release.Namespace }}
spec:
  endpointSelector:
    matchLabels:
      app: ent-analytics-web
  ingress:
    # Allow traffic from NGINX pod with SPIFFE mTLS
    - fromEndpoints:
        - matchLabels:
            app: nginx
      toPorts:
        - ports:
            - port: "8050"
              protocol: TCP
          terminatingTLS:
            spiffe:
              peerIDs:
                - spiffe://{{ .Values.ciliumNetworkPolicy.trustDomain }}/ns/{{ .Release.Namespace }}/sa/nginx
    # Allow health checks from kubelet
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "8050"
              protocol: TCP

---
# Policy 6: Protect Analytics API Pod
# Allows access from NGINX and Analytics Web pods with SPIFFE mTLS
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: analytics-api-ingress-policy
  namespace: {{ .Release.Namespace }}
spec:
  endpointSelector:
    matchLabels:
      app: ent-analytics-api
  ingress:
    # Allow traffic with SPIFFE mTLS
    - fromEndpoints:
        - matchLabels:
            app: nginx
        - matchLabels:
            app: ent-analytics-web
      toPorts:
        - ports:
            - port: "8000"
              protocol: TCP
          terminatingTLS:
            spiffe:
              peerIDs:
                - spiffe://{{ .Values.ciliumNetworkPolicy.trustDomain }}/ns/{{ .Release.Namespace }}/sa/nginx
                - spiffe://{{ .Values.ciliumNetworkPolicy.trustDomain }}/ns/{{ .Release.Namespace }}/sa/ent-analytics-web
    # Allow health checks from kubelet
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "8000"
              protocol: TCP
{{- end }}
{{- end }}
