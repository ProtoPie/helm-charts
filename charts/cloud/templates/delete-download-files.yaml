kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: kubectl-exec-runner
  labels:
    {{- include "protopie.labels" . | nindent 4 }}
rules:
  - apiGroups:
    - ""
    resources:
    - "pods"
    - "pods/log"
    verbs:
    - "get"
    - "list"
  - apiGroups:
    - ""
    resources:
    - "pods/exec"
    verbs:
    - "create"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: delete-download-sa
  labels:
    {{- include "protopie.labels" . | nindent 4 }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: kubectl-exec-runner--delete-download-sa
  labels:
    {{- include "protopie.labels" . | nindent 4 }}
subjects:
  - kind: ServiceAccount
    name: delete-download-sa
roleRef:
  kind: Role
  name: kubectl-exec-runner
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: delete-download-files
  labels:
    {{- include "protopie.labels" . | nindent 4 }}
spec:
  schedule: {{ .Values.cloud.cleanUpSchedule | quote }}
  concurrencyPolicy: Forbid
  backoffLimit: 0 # 실패 시 재시도 안함
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: delete-download-sa
          restartPolicy: Never
          activeDeadlineSeconds: 300
          terminationGracePeriodSeconds: 30 # SIGTERM 후 30초 대기 (cleanup 완료 유예)
          containers:
            - name: delete-download-files
              image: bitnami/kubectl:latest
              imagePullPolicy: IfNotPresent
              command:
                - /bin/sh
                - -c
                - |
                  POD_NAME="enterprise-cloud-api-0"

                  # Pod 존재 여부 먼저 확인
                  if kubectl get pod "$POD_NAME" -n {{ .Release.Namespace }} --request-timeout=10s; then
                    echo "[$(date)] Pod $POD_NAME found. Cleaning /app/download..."
                    kubectl exec pod/$POD_NAME -n {{ .Release.Namespace }} --request-timeout=10s -- sh -c 'rm -rf /app/download/*'
                    echo "[$(date)] Cleanup completed."
                  else
                    echo "[$(date)] Pod $POD_NAME not found. Skipping cleanup."
                  fi

                  # 항상 정상 종료
                  exit 0
